## Query Лабораторная работа №12

Генерация отчётов общих и промежуточных итогов. **ROLLUP, CUBE и GROUPING SETS**.

## Цель работы

Изучить работу **ROLLUP, CUBE и GROUPING SETS**.

## Ход работы

**Schema (PostgreSQL v13)**

Схема таблицы, с которой мы будем работать:

```sql
CREATE TABLE employee (
  employee_id serial PRIMARY KEY,
  name text NOT NULL,
  department text NOT NULL,
  salary numeric NOT NULL,
  year integer NOT NULL
);
```

---



**Заполнение таблицы**

```sql
SELECT * FROM employee;
```

| employee_id | name             | department   | salary | year |
| ----------- | ---------------- | ------------ | ------ | ---- |
| 1           | Курочкин Михаил  | Руководство  | 100000 | 2014 |
| 2           | Щевелёва Татьяна | Бухгалтерия  | 40000  | 2014 |
| 3           | Граций Артём     | ИТ отдел     | 60000  | 2014 |
| 4           | Муравьев Семён   | Отдел продаж | 50000  | 2014 |
| 5           | Комаров Ян       | Отдел продаж | 45000  | 2014 |
| 6           | Пашпарс Диана    | ИТ отдел     | 65000  | 2014 |
| 7           | Павельев Денис   | Бухгалтерия  | 30000  | 2014 |
| 11          | Муравьев Семён   | Отдел продаж | 50000  | 2015 |
| 12          | Комаров Ян       | Отдел продаж | 45000  | 2015 |
| 27          | Пашпарс Диана    | ИТ отдел     | 65000  | 2017 |
| 8           | Курочкин Михаил  | Руководство  | 110000 | 2015 |
| 9           | Щевелёва Татьяна | Бухгалтерия  | 42000  | 2015 |
| 10          | Граций Артём     | ИТ отдел     | 63000  | 2015 |
| 13          | Пашпарс Диана    | ИТ отдел     | 60000  | 2015 |
| 14          | Павельев Денис   | Бухгалтерия  | 32000  | 2015 |
| 15          | Курочкин Михаил  | Руководство  | 120000 | 2016 |
| 16          | Щевелёва Татьяна | Бухгалтерия  | 45000  | 2016 |
| 17          | Граций Артём     | ИТ отдел     | 65000  | 2016 |
| 18          | Муравьев Семён   | Отдел продаж | 52000  | 2016 |
| 19          | Комаров Ян       | Отдел продаж | 47000  | 2016 |
| 20          | Пашпарс Диана    | ИТ отдел     | 62000  | 2016 |
| 21          | Павельев Денис   | Бухгалтерия  | 35000  | 2016 |
| 22          | Курочкин Михаил  | Руководство  | 130000 | 2017 |
| 23          | Щевелёва Татьяна | Бухгалтерия  | 50000  | 2017 |
| 24          | Граций Артём     | ИТ отдел     | 65000  | 2017 |
| 25          | Муравьев Семён   | Отдел продаж | 53000  | 2017 |
| 26          | Комаров Ян       | Отдел продаж | 50000  | 2017 |
| 28          | Павельев Денис   | Бухгалтерия  | 37000  | 2017 |

---




Нам дали задание, вывести суммарно затраты на заработную плату по годам, по отделам и всего. Для этого мы написали три запроса с простейшим GROUP BY:



**Запрос 1, Выборка по годам**

```sql
SELECT year, SUM(salary) as Total
FROM employee
GROUP BY year
ORDER BY year;
```

| year | total  |
| ---- | ------ |
| 2014 | 390000 |
| 2015 | 402000 |
| 2016 | 426000 |
| 2017 | 450000 |



**Запрос 2, Выборка по отделам**

```sql
SELECT department, SUM(salary) as Total
FROM employee
GROUP BY department
ORDER BY department;
```

| department   | total  |
| ------------ | ------ |
| Бухгалтерия  | 311000 |
| ИТ отдел     | 505000 |
| Отдел продаж | 392000 |
| Руководство  | 460000 |



**Запрос 3, Выборка всего**

```sql
SELECT SUM(salary) as Total FROM employee;
```

| total   |
| ------- |
| 1668000 |

---


Всё выше представленое мы можем сделать одним запросом:



**Использование GROUPING SETS**

```sql
SELECT department, year, SUM(salary) as Total
FROM employee
GROUP BY GROUPING SETS ((department), (year), ());
```

| department   | year | total   |
| ------------ | ---- | ------- |
|              |      | 1668000 |
| Руководство  |      | 460000  |
| Отдел продаж |      | 392000  |
| Бухгалтерия  |      | 311000  |
| ИТ отдел     |      | 505000  |
|              | 2017 | 450000  |
|              | 2016 | 426000  |
|              | 2014 | 390000  |
|              | 2015 | 402000  |



---
Теперь босс сказал, я хочу видеть такие показатели: затраты не просто по отделам, а по отделам и году совеместно. Легко сказали мы, и просто добавили одно слово в наш запрос и дальше пошли пить кофе.



**Query #6**

```sql
SELECT department, year, SUM(salary) as Total
FROM employee
GROUP BY GROUPING SETS ((year, department), (year), ())
ORDER BY year, department;
```

| department   | year | total   |
| ------------ | ---- | ------- |
| Бухгалтерия  | 2014 | 70000   |
| ИТ отдел     | 2014 | 125000  |
| Отдел продаж | 2014 | 95000   |
| Руководство  | 2014 | 100000  |
|              | 2014 | 390000  |
| Бухгалтерия  | 2015 | 74000   |
| ИТ отдел     | 2015 | 123000  |
| Отдел продаж | 2015 | 95000   |
| Руководство  | 2015 | 110000  |
|              | 2015 | 402000  |
| Бухгалтерия  | 2016 | 80000   |
| ИТ отдел     | 2016 | 127000  |
| Отдел продаж | 2016 | 99000   |
| Руководство  | 2016 | 120000  |
|              | 2016 | 426000  |
| Бухгалтерия  | 2017 | 87000   |
| ИТ отдел     | 2017 | 130000  |
| Отдел продаж | 2017 | 103000  |
| Руководство  | 2017 | 130000  |
|              | 2017 | 450000  |
|              |      | 1668000 |

---
Выражение выше можно записать ещё проще, используя `ROLLUP`.



**Использование ROLLUP**

```sql
SELECT department, year, SUM(salary) as Total
FROM employee
GROUP BY ROLLUP(year, department)
ORDER BY year, department;
```

| department   | year | total   |
| ------------ | ---- | ------- |
| Бухгалтерия  | 2014 | 70000   |
| ИТ отдел     | 2014 | 125000  |
| Отдел продаж | 2014 | 95000   |
| Руководство  | 2014 | 100000  |
|              | 2014 | 390000  |
| Бухгалтерия  | 2015 | 74000   |
| ИТ отдел     | 2015 | 123000  |
| Отдел продаж | 2015 | 95000   |
| Руководство  | 2015 | 110000  |
|              | 2015 | 402000  |
| Бухгалтерия  | 2016 | 80000   |
| ИТ отдел     | 2016 | 127000  |
| Отдел продаж | 2016 | 99000   |
| Руководство  | 2016 | 120000  |
|              | 2016 | 426000  |
| Бухгалтерия  | 2017 | 87000   |
| ИТ отдел     | 2017 | 130000  |
| Отдел продаж | 2017 | 103000  |
| Руководство  | 2017 | 130000  |
|              | 2017 | 450000  |
|              |      | 1668000 |

---
**Query #8**

```sql
SELECT department, year, SUM(salary) as Total
FROM employee
GROUP BY GROUPING SETS ((year, department), (year), (department), ())
ORDER BY year, department;
```

| department   | year | total   |
| ------------ | ---- | ------- |
| Бухгалтерия  | 2014 | 70000   |
| ИТ отдел     | 2014 | 125000  |
| Отдел продаж | 2014 | 95000   |
| Руководство  | 2014 | 100000  |
|              | 2014 | 390000  |
| Бухгалтерия  | 2015 | 74000   |
| ИТ отдел     | 2015 | 123000  |
| Отдел продаж | 2015 | 95000   |
| Руководство  | 2015 | 110000  |
|              | 2015 | 402000  |
| Бухгалтерия  | 2016 | 80000   |
| ИТ отдел     | 2016 | 127000  |
| Отдел продаж | 2016 | 99000   |
| Руководство  | 2016 | 120000  |
|              | 2016 | 426000  |
| Бухгалтерия  | 2017 | 87000   |
| ИТ отдел     | 2017 | 130000  |
| Отдел продаж | 2017 | 103000  |
| Руководство  | 2017 | 130000  |
|              | 2017 | 450000  |
| Бухгалтерия  |      | 311000  |
| ИТ отдел     |      | 505000  |
| Отдел продаж |      | 392000  |
| Руководство  |      | 460000  |
|              |      | 1668000 |

---
**Query #9**

```sql
SELECT department, year, SUM(salary) as Total
FROM employee
GROUP BY CUBE(year, department)
ORDER BY year, department;
```

| department   | year | total   |
| ------------ | ---- | ------- |
| Бухгалтерия  | 2014 | 70000   |
| ИТ отдел     | 2014 | 125000  |
| Отдел продаж | 2014 | 95000   |
| Руководство  | 2014 | 100000  |
|              | 2014 | 390000  |
| Бухгалтерия  | 2015 | 74000   |
| ИТ отдел     | 2015 | 123000  |
| Отдел продаж | 2015 | 95000   |
| Руководство  | 2015 | 110000  |
|              | 2015 | 402000  |
| Бухгалтерия  | 2016 | 80000   |
| ИТ отдел     | 2016 | 127000  |
| Отдел продаж | 2016 | 99000   |
| Руководство  | 2016 | 120000  |
|              | 2016 | 426000  |
| Бухгалтерия  | 2017 | 87000   |
| ИТ отдел     | 2017 | 130000  |
| Отдел продаж | 2017 | 103000  |
| Руководство  | 2017 | 130000  |
|              | 2017 | 450000  |
| Бухгалтерия  |      | 311000  |
| ИТ отдел     |      | 505000  |
| Отдел продаж |      | 392000  |
| Руководство  |      | 460000  |
|              |      | 1668000 |

---

[View on DB Fiddle](https://www.db-fiddle.com/f/nhzbh58PSd8op6M6c4JpSD/2)



## Задание 

Выполнять тут:

https://www.db-fiddle.com/ или  http://sqlfiddle.com/ или на вашей локальной машине, но все коды работ загрузить на соответствующий сервис.



## Требования к отчёту

1. Титульная страница 

   Титульная страница должна содержать:

   1. Наименование учебного учреждения
   2. Наименование предмета
   3. Фамилию и инициалы студента
   4. Фамилию и инициалы преподавателя принимающего работу
   5. **Номер индивидуального задания** (если имеется)

2. Цель работы

3. Выполнение задания

4. **Ссылка на работу** https://www.db-fiddle.com или http://sqlfiddle.com/ ссылка должна быть выделена **жирным текстом** и в тексте присутствовать полностью. Несмотря на предоставление ссылки на работу все коды программы должны полностью присутствовать в отчёте.

5. Выводы по работе