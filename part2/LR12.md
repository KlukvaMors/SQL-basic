## Query Лабораторная работа №12

Генерация отчётов общих и промежуточных итогов. **ROLLUP, CUBE и GROUPING SETS**.

## Цель работы

Изучить работу **ROLLUP, CUBE и GROUPING SETS**.

## Ход работы

**Schema (PostgreSQL v13)**

Схема таблицы, с которой мы будем работать:

```sql
CREATE TABLE employee (
  employee_id serial PRIMARY KEY,
  name text NOT NULL,
  department text NOT NULL,
  salary numeric NOT NULL,
  year integer NOT NULL
);
```

---



**Заполнение таблицы**

```sql
SELECT * FROM employee;
```

| employee_id | name             | department   | salary | year |
| ----------- | ---------------- | ------------ | ------ | ---- |
| 1           | Курочкин Михаил  | Руководство  | 100000 | 2014 |
| 2           | Щевелёва Татьяна | Бухгалтерия  | 40000  | 2014 |
| 3           | Граций Артём     | ИТ отдел     | 60000  | 2014 |
| 4           | Муравьев Семён   | Отдел продаж | 50000  | 2014 |
| 5           | Комаров Ян       | Отдел продаж | 45000  | 2014 |
| 6           | Пашпарс Диана    | ИТ отдел     | 65000  | 2014 |
| 7           | Павельев Денис   | Бухгалтерия  | 30000  | 2014 |
| 11          | Муравьев Семён   | Отдел продаж | 50000  | 2015 |
| 12          | Комаров Ян       | Отдел продаж | 45000  | 2015 |
| 27          | Пашпарс Диана    | ИТ отдел     | 65000  | 2017 |
| 8           | Курочкин Михаил  | Руководство  | 110000 | 2015 |
| 9           | Щевелёва Татьяна | Бухгалтерия  | 42000  | 2015 |
| 10          | Граций Артём     | ИТ отдел     | 63000  | 2015 |
| 13          | Пашпарс Диана    | ИТ отдел     | 60000  | 2015 |
| 14          | Павельев Денис   | Бухгалтерия  | 32000  | 2015 |
| 15          | Курочкин Михаил  | Руководство  | 120000 | 2016 |
| 16          | Щевелёва Татьяна | Бухгалтерия  | 45000  | 2016 |
| 17          | Граций Артём     | ИТ отдел     | 65000  | 2016 |
| 18          | Муравьев Семён   | Отдел продаж | 52000  | 2016 |
| 19          | Комаров Ян       | Отдел продаж | 47000  | 2016 |
| 20          | Пашпарс Диана    | ИТ отдел     | 62000  | 2016 |
| 21          | Павельев Денис   | Бухгалтерия  | 35000  | 2016 |
| 22          | Курочкин Михаил  | Руководство  | 130000 | 2017 |
| 23          | Щевелёва Татьяна | Бухгалтерия  | 50000  | 2017 |
| 24          | Граций Артём     | ИТ отдел     | 65000  | 2017 |
| 25          | Муравьев Семён   | Отдел продаж | 53000  | 2017 |
| 26          | Комаров Ян       | Отдел продаж | 50000  | 2017 |
| 28          | Павельев Денис   | Бухгалтерия  | 37000  | 2017 |

---




Нам дали задание, вывести суммарно затраты на заработную плату по годам, по отделам и всего. Для этого мы написали три запроса с простейшим GROUP BY:



**Запрос 1, Выборка по годам**

```sql
SELECT year, SUM(salary) as Total
FROM employee
GROUP BY year
ORDER BY year;
```

| year | total  |
| ---- | ------ |
| 2014 | 390000 |
| 2015 | 402000 |
| 2016 | 426000 |
| 2017 | 450000 |



**Запрос 2, Выборка по отделам**

```sql
SELECT department, SUM(salary) as Total
FROM employee
GROUP BY department
ORDER BY department;
```

| department   | total  |
| ------------ | ------ |
| Бухгалтерия  | 311000 |
| ИТ отдел     | 505000 |
| Отдел продаж | 392000 |
| Руководство  | 460000 |



**Запрос 3, Выборка всего**

```sql
SELECT SUM(salary) as Total FROM employee;
```

| total   |
| ------- |
| 1668000 |

---


Всё выше представленое мы можем сделать одним запросом:



**Использование GROUPING SETS**

```sql
SELECT department, year, SUM(salary) as Total
FROM employee
GROUP BY GROUPING SETS ((department), (year), ());
```

| department   | year | total   |
| ------------ | ---- | ------- |
|              |      | 1668000 |
| Руководство  |      | 460000  |
| Отдел продаж |      | 392000  |
| Бухгалтерия  |      | 311000  |
| ИТ отдел     |      | 505000  |
|              | 2017 | 450000  |
|              | 2016 | 426000  |
|              | 2014 | 390000  |
|              | 2015 | 402000  |



---
Теперь босс сказал, я хочу видеть такие показатели: затраты не просто по отделам, а по отделам и году совеместно. Легко сказали мы, и просто добавили одно слово в наш запрос и дальше пошли пить кофе.



**Query #6**

```sql
SELECT department, year, SUM(salary) as Total
FROM employee
GROUP BY GROUPING SETS ((year, department), (year), ())
ORDER BY year, department;
```

| department   | year | total   |
| ------------ | ---- | ------- |
| Бухгалтерия  | 2014 | 70000   |
| ИТ отдел     | 2014 | 125000  |
| Отдел продаж | 2014 | 95000   |
| Руководство  | 2014 | 100000  |
|              | 2014 | 390000  |
| Бухгалтерия  | 2015 | 74000   |
| ИТ отдел     | 2015 | 123000  |
| Отдел продаж | 2015 | 95000   |
| Руководство  | 2015 | 110000  |
|              | 2015 | 402000  |
| Бухгалтерия  | 2016 | 80000   |
| ИТ отдел     | 2016 | 127000  |
| Отдел продаж | 2016 | 99000   |
| Руководство  | 2016 | 120000  |
|              | 2016 | 426000  |
| Бухгалтерия  | 2017 | 87000   |
| ИТ отдел     | 2017 | 130000  |
| Отдел продаж | 2017 | 103000  |
| Руководство  | 2017 | 130000  |
|              | 2017 | 450000  |
|              |      | 1668000 |

---
Выражение выше можно записать ещё проще, используя `ROLLUP`.

В общем случае `ROLLUP` эквивалентно:

```sql
ROLLUP ( e1, e2, e3, ... )
```

 представляет заданный список выражений и всех префиксов списка, включая пустой список; то есть оно равнозначно записи 

```sql
GROUPING SETS (
    ( e1, e2, e3, ... ),
    ...
    ( e1, e2 ),
    ( e1 ),
    ( )
)
```

 Значит `ROLLUP(year, department)`

Равно такой записи: `GROUPING SETS ((year, department), (year), ())`, что и было у нас в предыдущем запросе.



**Использование ROLLUP**

```sql
SELECT department, year, SUM(salary) as Total
FROM employee
GROUP BY ROLLUP(year, department)
ORDER BY year, department;
```

| department   | year | total   |
| ------------ | ---- | ------- |
| Бухгалтерия  | 2014 | 70000   |
| ИТ отдел     | 2014 | 125000  |
| Отдел продаж | 2014 | 95000   |
| Руководство  | 2014 | 100000  |
|              | 2014 | 390000  |
| Бухгалтерия  | 2015 | 74000   |
| ИТ отдел     | 2015 | 123000  |
| Отдел продаж | 2015 | 95000   |
| Руководство  | 2015 | 110000  |
|              | 2015 | 402000  |
| Бухгалтерия  | 2016 | 80000   |
| ИТ отдел     | 2016 | 127000  |
| Отдел продаж | 2016 | 99000   |
| Руководство  | 2016 | 120000  |
|              | 2016 | 426000  |
| Бухгалтерия  | 2017 | 87000   |
| ИТ отдел     | 2017 | 130000  |
| Отдел продаж | 2017 | 103000  |
| Руководство  | 2017 | 130000  |
|              | 2017 | 450000  |
|              |      | 1668000 |

---


Теперь босс сказал: *"Хочу видеть суммарные показатели затрат на ЗП всего, в годам, по отделам, и по отделам и годам вместе"*. С помощью `ROLLUP` такое мы реализовать не сможем, так что вернёмся к `GROUPING SETS` и запишем требования босса в виде запроса.



**Все возможные показатели по отделам и годам с помощью GROUPING SETS**

```sql
SELECT department, year, SUM(salary) as Total
FROM employee
GROUP BY GROUPING SETS ((year, department), (year), (department), ())
ORDER BY year, department;
```

| department   | year | total   |
| ------------ | ---- | ------- |
| Бухгалтерия  | 2014 | 70000   |
| ИТ отдел     | 2014 | 125000  |
| Отдел продаж | 2014 | 95000   |
| Руководство  | 2014 | 100000  |
|              | 2014 | 390000  |
| Бухгалтерия  | 2015 | 74000   |
| ИТ отдел     | 2015 | 123000  |
| Отдел продаж | 2015 | 95000   |
| Руководство  | 2015 | 110000  |
|              | 2015 | 402000  |
| Бухгалтерия  | 2016 | 80000   |
| ИТ отдел     | 2016 | 127000  |
| Отдел продаж | 2016 | 99000   |
| Руководство  | 2016 | 120000  |
|              | 2016 | 426000  |
| Бухгалтерия  | 2017 | 87000   |
| ИТ отдел     | 2017 | 130000  |
| Отдел продаж | 2017 | 103000  |
| Руководство  | 2017 | 130000  |
|              | 2017 | 450000  |
| Бухгалтерия  |      | 311000  |
| ИТ отдел     |      | 505000  |
| Отдел продаж |      | 392000  |
| Руководство  |      | 460000  |
|              |      | 1668000 |

---


Запрос выше мы можем записать проще, с помощью `CUBE`.

Запись:

```sql
CUBE ( a, b, c )
```

 равнозначна 

```sql
GROUPING SETS (
    ( a, b, c ),
    ( a, b    ),
    ( a,    c ),
    ( a       ),
    (    b, c ),
    (    b    ),
    (       c ),
    (         )
)
```

То есть запись: `CUBE(year, department)` равна `GROUPING SETS ((year, department), (year), (department), ())`, то что и было у нас в прошлом запросе.



**Все возможные показатели по отделам и годам с помощью CUBE**

```sql
SELECT department, year, SUM(salary) as Total
FROM employee
GROUP BY CUBE(year, department)
ORDER BY year, department;
```

| department   | year | total   |
| ------------ | ---- | ------- |
| Бухгалтерия  | 2014 | 70000   |
| ИТ отдел     | 2014 | 125000  |
| Отдел продаж | 2014 | 95000   |
| Руководство  | 2014 | 100000  |
|              | 2014 | 390000  |
| Бухгалтерия  | 2015 | 74000   |
| ИТ отдел     | 2015 | 123000  |
| Отдел продаж | 2015 | 95000   |
| Руководство  | 2015 | 110000  |
|              | 2015 | 402000  |
| Бухгалтерия  | 2016 | 80000   |
| ИТ отдел     | 2016 | 127000  |
| Отдел продаж | 2016 | 99000   |
| Руководство  | 2016 | 120000  |
|              | 2016 | 426000  |
| Бухгалтерия  | 2017 | 87000   |
| ИТ отдел     | 2017 | 130000  |
| Отдел продаж | 2017 | 103000  |
| Руководство  | 2017 | 130000  |
|              | 2017 | 450000  |
| Бухгалтерия  |      | 311000  |
| ИТ отдел     |      | 505000  |
| Отдел продаж |      | 392000  |
| Руководство  |      | 460000  |
|              |      | 1668000 |

---

[View on DB Fiddle](https://www.db-fiddle.com/f/nhzbh58PSd8op6M6c4JpSD/2)



## Задание 

Дан топ 250 фильмов Кинопоиска в таблице `kinopoisk`:

**Schema (PostgreSQL v12)**

```sql
CREATE TABLE "kinopoisk" (
  ID serial PRIMARY KEY,
  rating numeric NOT NULL,
  movie text NOT NULL,
  year integer NOT NULL,
  rating_ball numeric NOT NULL,
  country text NOT NULL,
  overview text NULL,
  director text NOT NULL,
  screenwriter text NOT NULL,
  actors text NULL
);
```

```sql
SELECT * FROM kinopoisk LIMIT 3;
```

| id   | rating | movie             | year | rating_ball | country | overview                                  | director       | screenwriter                | actors |
| ---- | ------ | ----------------- | ---- | ----------- | ------- | ----------------------------------------- | -------------- | --------------------------- | ------ |
| 1    | 0      | Побег из Шоушенка | 1994 | 9.111       | США     | Бухгалтер Энди Дюфрейн обвинён...         | Фрэнк Дарабонт | Фрэнк Дарабонт  Стивен Кинг | ...    |
| 2    | 1      | Зеленая миля      | 1999 | 9.062       | США     | Пол Эджкомб — начальник блока ...         | Фрэнк Дарабонт | Фрэнк Дарабонт  Стивен Кинг | ...    |
| 3    | 2      | Форрест Гамп      | 1994 | 8.913       | США     | От лица главного героя Форреста Гампа ... | Роберт Земекис | Эрик Рот  Уинстон Грум      | ...    |

---

[View on DB Fiddle](https://www.db-fiddle.com/f/bs1LfojnfYHyWGrCq347ni/3)



### Вариант 1

Сделать анализ (отчёт) с помощью SQL запроса и ROLLUP, CUBE, GROUPING SETS сколько фильмов было снято:

- по годам
- по странам
- по годам и странам вместе

Задание выполнять тут: [тут](https://www.db-fiddle.com/f/bs1LfojnfYHyWGrCq347ni/3)



### Вариант 2

Сделать анализ (отчёт) с помощью SQL запроса и ROLLUP, CUBE, GROUPING SETS сколько фильмов было снято:

- по годам
- по режиссерам
- по годам и режиссерам вместе

Задание выполнять тут: [тут](https://www.db-fiddle.com/f/bs1LfojnfYHyWGrCq347ni/3)



### Вариант 3

Сделать анализ (отчёт) с помощью SQL запроса и ROLLUP, CUBE, GROUPING SETS сумарного рейтинга получили фильмы:

- по годам
- по странам
- по годам и странам вместе

Задание выполнять тут: [тут](https://www.db-fiddle.com/f/bs1LfojnfYHyWGrCq347ni/3)



## Требования к отчёту

1. Титульная страница 

   Титульная страница должна содержать:

   1. Наименование учебного учреждения
   2. Наименование предмета
   3. Фамилию и инициалы студента
   4. Фамилию и инициалы преподавателя принимающего работу
   5. **Номер индивидуального задания** (если имеется)

2. Цель работы

3. Выполнение задания

4. **Ссылка на работу** https://www.db-fiddle.com или http://sqlfiddle.com/ ссылка должна быть выделена **жирным текстом** и в тексте присутствовать полностью. Несмотря на предоставление ссылки на работу все коды программы должны полностью присутствовать в отчёте.

5. Выводы по работе